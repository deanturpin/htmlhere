<h1>Travis CI - repo configuration</h1>
Create an account with your GitHub login and enable a repo to get started.
(Travis Pro appears to enable new repos by default.)

<h2>C++11 - simple builds</h2>
If you just want to get something building quickly the default Trusty build has
clang 5 pre-installed, no need for complicated matrices.

Travis config
<pre>
script: clang++ --version
<pre>

Travis build debug
<pre>
$ clang++ --version
clang version 5.0.0 (tags/RELEASE_500/final)
<pre>

<h2>C++ builds</h2>
Building for clang and gcc. These could be run as separate jobs but you
then have to handle each build attempting to deploy.
<pre>
script:
- make CXX=clang++-6.0
- make clean
- make CXX=g++-8
- cppcheck --enable=all .
- sloccount *.cpp

matrix:
include:
- os: linux
addons:
apt:
update: true
sources:
- ubuntu-toolchain-r-test
- llvm-toolchain-trusty-8.0
packages:
- clang++-8.0
- g++-8
- cppcheck
- sloccount
<pre>
<h2>C++ code coverage</h2>
Create a [codecov.io](https://codecov.io/) account with your GitHub credentials
and simply push your coverage files via Travis CI using the generic upload
script as a build stage (no need to enable the repo). Build your C++ using the
<pre>
get sensible coverage results when compiling with gcc 6.

<pre>
script:
- bash <(curl -s https://codecov.io/bash)
<pre>

<h2>Branch merge</h2>
An unexpected side-effect of using Travis CI is that your branch is
automatically built as part of the merge verification.

![](branch_merge.png)

You're also offered a Codecov report for the merge.
![](code_coverage_merge_report.png)

<h2>Deploying to GitHub Pages</h2>
In the Travis CI repo settings create a private environment variable containing
your GitHub API key, this replaces the GitHub token below (note: use hyphens
not underscores). All branches are built in Travis CI by default but in this
example on the master branch will be deployed. Deploying for the first time
will create a "gh-pages" branch and set up the username.github.io/repo static
web page. I like to use this to generate "live" READMEs containing recent data.

Create an API key in your [GitHub
settings](https://github.com/settings/tokens), tick "repo" and
"admin:public_key". "skip-cleanup" is set to true because you probably want to
deploy the things you've generated.

Finally, in your GitHub repo settings ensure the GitHub Pages section "source" is gh-pages branch.

<pre>
deploy:
provider: pages
github-token: ${github_token}
skip-cleanup: true
on:
branch: master
<pre>

<h1>R with packages</h1>
<pre>
language: R
install:
- R -e "install.packages('csv')"
- R -e "install.packages('rjson')"
- R -e "install.packages('rmarkdown')"

script: make
<pre>

<h2>bash with dot</h2>
<pre>
script: make
install: sudo apt install graphviz
<pre>

<h2>Python with requests</h2>
HTTP requests aren't available by default so you must instruct Travis CI to
make it so using an additional "requirements" file.
<pre>
language: python
python: "3.6"
script: make

<h1>This is implicit</h1>
<h1>pip install -r requirements.txt</h1>
<pre>

<pre>
of dependencies.
<pre>
requests
<pre>

<h1>Linting and profiling</h1>
<pre>
then process the results as part of your build script.
<pre>
script:
- make
- ./spectrum.o
- gprof ./spectrum.o
<pre>

<pre>
build stage.
<pre>
script:
- cppcheck --enable=all .
<pre>

<pre>
codebase.

<h1>Compiler options</h1>
<pre>
<h1>Standard</h1>
--std=c++2a --all-warnings --extra-warnings --pedantic-errors

<h1>Warnings that are not included by *all* and *extra* but sound like a thing we</h1>
<h1>want to know about</h1>
-Werror -Wshadow -Wfloat-equal -Weffc++ -Wdelete-non-virtual-dtor -Warray-bounds -Wattribute-alias -Wformat-overflow -Wformat-truncation -Wmissing-attributes -Wstringop-truncation -Wdeprecated-copy -Wclass-conversion
<h1>And a whisper of optimisation</h1>
-O1

<h1>Profiler</h1>
-pg

<h1>Code coverage (gcc only, ignored by clang)</h1>
-g --coverage
<pre>

<h1>Travis CI - triggering builds using the API</h1>
You can configure a daily cron job via the Travis settings but for more
frequent builds set up your own cron job on a Linux web server and use the
Travis API. Note the .org in the API URL, if you use the wrong one (.com) it
will simply report "access denied". There's a different API key for the Pro
<pre>
script below (leave the "%2").

<pre>
@hourly nice ~/trigger.sh
<pre>

<pre>
<h1>!/bin/bash</h1>

body=$(cat <<!
{
"request": {
"branch":"master",
"message":"cron $(date)"
}
}
!
)

curl -s -X POST -H "Content-Type: application/json" -H "Accept: application/json" -H "Travis-API-Version: 3" -H "Authorization: token TOKEN" -d "$body" "https://api.travis-ci.org/repo/USERNAME%2FREPO/requests" >& /dev/null
<pre>

<h1>Clang format on pre-commit</h1>
I use a global git configuration that runs clang-format on all C++ files as
they are pushed to the server. See
[githooks](https://github.com/deanturpin/githooks). I've changed my mind about
coding standards many times over the years, next time I can just create a new
format configuration and run it over my code. This also avoids you having to
spend time pondering how to format bracket-heavy features like lambdas and
initialiser lists.

<pre>
for file in $(git diff-index --cached --name-only HEAD); do
if [[ $file == *.cpp || $file == *.h ]]; then
clang-format -i "$file"
git add "$file"
fi
done
<pre>

<h1>Uptime monitoring</h1>
See [uptime robot](https://stats.uptimerobot.com/V7YEVs8gv).

<h1>References</h1>
htmlhere.sh index.html makefile readme.md [Travis CI C++ instructions](https://docs.travis-ci.com/user/languages/cpp/)
htmlhere.sh index.html makefile readme.md [arne-mertz.de continuous integration](https://arne-mertz.de/2017/04/continuous-integration-travis-ci/)
